# -*- coding: utf-8 -*-
"""fandom_dashboard.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1KjM3ok-kaoEOp7H13hLza_gJ8NHR0I0a
"""

import streamlit as st
import pandas as pd


@st.cache_data

def load_data():
    df = pd.read_json("starwars_dataset.json")
    return df

df = load_data()

# –ó–∞–≥–æ–ª–æ–≤–æ–∫
st.title("Fandom Hypergraph: Star Wars Dashboard")

# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
st.header("üìä –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞")
st.markdown(f"**–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç–∞—Ç–µ–π:** {df['document_id'].nunique()}")
st.markdown(f"**–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–∞–Ω–∫–æ–≤:** {len(df)}")
st.markdown(f"**–°—Ä–µ–¥–Ω—è—è –¥–ª–∏–Ω–∞ —á–∞–Ω–∫–∞ (–≤ —Å–ª–æ–≤–∞—Ö):** {int(df['chunk_text'].apply(lambda x: len(str(x).split())).mean())}")
st.markdown(f"**–°—Ä–µ–¥–Ω–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Å—ã–ª–æ–∫ –Ω–∞ —á–∞–Ω–∫:** {round(df['outgoing_links'].apply(len).mean(), 2)}")

# –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
st.header("üîç –ü–æ–∏—Å–∫ –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è")

search_term = st.text_input("–ü–æ–∏—Å–∫ –ø–æ –∑–∞–≥–æ–ª–æ–≤–∫—É —Å—Ç–∞—Ç—å–∏")
sort_option = st.selectbox("–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ", ["–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–∞–Ω–∫–æ–≤", "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Å—ã–ª–æ–∫"])

filtered = df.copy()
if search_term:
    filtered = filtered[filtered['title'].str.contains(search_term, case=False, na=False)]

if sort_option == "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–∞–Ω–∫–æ–≤":
    sort_df = filtered.groupby("title")["chunk_id"].count().reset_index(name="chunks").sort_values(by="chunks", ascending=False)
elif sort_option == "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Å—ã–ª–æ–∫":
    sort_df = filtered.groupby("title")["outgoing_links"].apply(lambda x: sum(len(l) for l in x)).reset_index(name="links").sort_values(by="links", ascending=False)

st.dataframe(sort_df.head(20))

# –ü—Ä–æ—Å–º–æ—Ç—Ä —Å—Ç–∞—Ç—å–∏ –∏ —á–∞–Ω–∫–æ–≤
st.header("üìö –ü—Ä–æ—Å–º–æ—Ç—Ä —Å—Ç–∞—Ç—å–∏")
unique_titles = sorted(filtered['title'].unique())
selected_title = st.selectbox("–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞—Ç—å—é", unique_titles)

chunks = filtered[filtered['title'] == selected_title].sort_values(by="chunk_id")
for _, row in chunks.iterrows():
    st.subheader(f"–ß–∞–Ω–∫ {row['chunk_id']}")
    st.text_area("–¢–µ–∫—Å—Ç —á–∞–Ω–∫–∞", value=row['chunk_text'], height=150)
    st.markdown(f"**–°—Å—ã–ª–∞–µ—Ç—Å—è –Ω–∞:** {', '.join(row['outgoing_links']) if row['outgoing_links'] else '‚Äî'}")
    st.markdown(f"[–û—Ç–∫—Ä—ã—Ç—å —Å—Ç–∞—Ç—å—é –Ω–∞ Fandom]({row['source']})")